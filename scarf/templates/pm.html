{% extends "layout.html" %}

{% block body %}

{% include "login.html" %}

<div id="content">

{% if pd.pm.parentid > 0 %}
In reply to: <a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.parent.uid }}">{{ pd.pm.parent.subject }}</a></br>
{% endif %}

Subject {{ pd.pm.subject }}</br>
From: <a href="/user/{{ pd.pm.from_user }}">{{ pd.pm.from_user }}</a><br />
To: <a href="/user/{{ pd.pm.to_user}}">{{ pd.pm.to_user }}</a><br />
Sent: {{ pd.pm.sent }}</br>
Message:</br>
{{ pd.pm.message }}<br/>

{% for ti in pd.pm.items %}
    {% if ti.user.uid == pd.authuser.uid %}
    ----]] your trade: {{ ti.item.name }}<br/>
    {% if ti.user.uid == pd.authuser.uid %}
    {% if ti.acceptstatus < pd.pm.tradestatus['accepted'] %}
        <a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/accept/{{ ti.uid }}">Accept item</a><br />

        {% if ti.acceptstatus == pd.pm.tradestatus['rejected'] %}
        Rejected<br />
        {% else %}
        <a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/reject/{{ ti.uid }}">Reject item</a> 
        {% endif %}
    {% else %}
        Accepted<br />
    {%endif%}
    {%endif%}
 
    {% else %}
    [[---- {{ti.user.username }}'s trade: {{ ti.item.name }} - <br />

    {% if ti.user.uid == pd.authuser.uid %}
    {% if ti.acceptstatus < pd.pm.tradestatus['accepted'] %}
        <a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/accept/{{ ti.uid }}">Accept item</a><br />

        {% if ti.acceptstatus == pd.pm.tradestatus['rejected'] %}
        Rejected<br />
        {% else %}
        <a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/reject/{{ ti.uid }}">Reject item</a> 
        {% endif %}
    {% else %}
        Accepted<br />
    {%endif%}
    {%endif%}
    {%endif%}
    {% if ti.item.images[0] is defined %}
        <img src="/image/{{ ti.item.images[0].filename }}/thumbnail" alt="{{ ti.item.images[0].tag }}"><br />
    {% endif %}
{% endfor %}

{% if pd.pm.status == pd.pm.messagestatus['complete_trade'] %}
All parties have accepted, please coordinate with {{ pd.pm.from_user }} to complete your trade!<br />
<a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/settle">Mark as settled!</a><br />
{% elif pd.pm.status == pd.pm.messagestatus['active_trade'] %}
<a href="/user/{{ pd.authuser.username }}/pm/{{ pd.pm.uid }}/reject">Reject trade</a><br />
{% elif pd.pm.status == pd.pm.messagestatus['rejected_trade'] %}
This trade has been closed as rejected!<br/>
{% elif pd.pm.status == pd.pm.messagestatus['settled_trade'] %}
Trade has been closed as settled!<br/>
{% endif %}

<h3>Replies:</h3><br>
{% for reply in pd.pm.replies %}
 - <a href="/user/{{ pd.authuser.username }}/pm/{{ reply.uid }}"> {{ reply.subject }}</a></br>
{% for reply2 in reply.replies %}
 \- <a href="/user/{{ pd.authuser.username }}/pm/{{ reply2.uid }}"> {{ reply2.subject }}</a></br>
{% for reply3 in reply2.replies %}
   \\- <a href="/user/{{ pd.authuser.username }}/pm/{{ reply3.uid }}"> {{ reply3.subject }}</a></br>
{% endfor %}
{% endfor %}
{% endfor %}

<h3> Reply: </h3>
    {% if pd.pm.from_user == pd.authuser.username %}
    <form action="/user/{{ pd.pm.to_user }}/pm" method="post" enctype="multipart/form-data">
    {% else %}
    <form action="/user/{{ pd.pm.from_user }}/pm" method="post" enctype="multipart/form-data">
    {% endif %}
        Subject: <input type=text name=subject value="re: {{ pd.pm.subject }}" required></br>
        Message: </br>
        <textarea name=body rows="4" cols="50"></textarea><br />
        <input type="hidden" name="parent" value="{{ pd.pm.uid }}">
        <input type=submit value=Submit>
    </form>


</div>

{% endblock %}
